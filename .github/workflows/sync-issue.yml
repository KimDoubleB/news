name: Sync Issues to Markdown

on:
  issues:
    types: [labeled, unlabeled, deleted]

jobs:
  check-label-and-sync:
    if: github.event.action == 'labeled' && contains(github.event.label.name, 'Ready to publish')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Process Issue
        run: |
          import os
          import json
          import requests
          from datetime import datetime
          
          # GitHub API ì„¤ì •
          GITHUB_TOKEN = os.getenv('GITHUB_TOKEN')
          GITHUB_API = "https://api.github.com"
          headers = {
              "Authorization": f"Bearer {GITHUB_TOKEN}",
              "Accept": "application/vnd.github.v3+json"
          }
          
          # ì´ë²¤íŠ¸ ë°ì´í„° ì½ê¸°
          event_path = os.getenv('GITHUB_EVENT_PATH')
          with open(event_path, 'r', encoding='utf-8') as f:
              event = json.load(f)
          
          # ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          issue = event['issue']
          issue_number = issue['number']
          repo_full_name = event['repository']['full_name']
          title = issue['title']
          body = issue['body'] or ''
          
          # í˜„ì¬ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸° (UTC ê¸°ì¤€)
          current_date = datetime.utcnow().strftime('%Y-%m-%d')
          
          # íŒŒì¼ëª… ìƒì„± (ë‚ ì§œ-ì´ìŠˆì œëª©.md)
          safe_title = title.lower().replace(' ', '-')
          # íŒŒì¼ëª…ì— ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¬¸ì ì œê±°
          safe_title = ''.join(c for c in safe_title if c.isalnum() or c in '-_')
          filename = f"_posts/{current_date}-{issue_number}-{safe_title}.md"
          
          # ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
          os.makedirs(os.path.dirname(filename), exist_ok=True)
          
          # ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ìƒì„±/ìˆ˜ì •
          with open(filename, 'w', encoding='utf-8') as f:
              f.write(body)
              f.write(f"\n\nLast updated: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC")
          
          # Git ì„¤ì •
          os.system('git config --global user.name "github-actions[bot]"')
          os.system('git config --global user.email "github-actions[bot]@users.noreply.github.com"')
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          os.system(f'git add "{filename}"')
          os.system(f'git commit -m "sync: Update issue #{issue_number} to markdown"')
          os.system('git push')
          
          # ì™„ë£Œ ì½”ë©˜íŠ¸ ì¶”ê°€
          comments_url = f"{GITHUB_API}/repos/{repo_full_name}/issues/{issue_number}/comments"
          comment_data = {
              "body": "ğŸš€ Publish complete ğŸŒ"
          }
          requests.post(comments_url, headers=headers, json=comment_data)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: python

  remove-on-unlabel:
    if: github.event.action == 'unlabeled' && contains(github.event.label.name, 'Ready to publish')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      
      - name: Remove Markdown
        run: |
          import os
          import json
          import glob
          import requests
          
          # GitHub API ì„¤ì •
          GITHUB_TOKEN = os.getenv('GITHUB_TOKEN')
          GITHUB_API = "https://api.github.com"
          headers = {
              "Authorization": f"Bearer {GITHUB_TOKEN}",
              "Accept": "application/vnd.github.v3+json"
          }
          
          # ì´ë²¤íŠ¸ ë°ì´í„° ì½ê¸°
          event_path = os.getenv('GITHUB_EVENT_PATH')
          with open(event_path, 'r', encoding='utf-8') as f:
              event = json.load(f)
          
          issue_number = event['issue']['number']
          repo_full_name = event['repository']['full_name']
          # í•´ë‹¹ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ê°€ì§„ íŒŒì¼ ì°¾ê¸°
          files = glob.glob(f"_posts/*{issue_number}-*.md")
          
          if files:
              # Git ì„¤ì •
              os.system('git config --global user.name "github-actions[bot]"')
              os.system('git config --global user.email "github-actions[bot]@users.noreply.github.com"')
              
              # íŒŒì¼ ì‚­ì œ ë° ì»¤ë°‹
              for file in files:
                  os.remove(file)
                  os.system(f'git add "{file}"')
              
              os.system(f'git commit -m "sync: Remove markdown for issue #{issue_number} (label removed)"')
              os.system('git push')

              # ì‚­ì œ ì™„ë£Œ ì½”ë©˜íŠ¸ ì¶”ê°€
              comments_url = f"{GITHUB_API}/repos/{repo_full_name}/issues/{issue_number}/comments"
              comment_data = {
                  "body": "ğŸ—‘ï¸ Markdown file has been removed ğŸ—‘ï¸"
              }
              requests.post(comments_url, headers=headers, json=comment_data)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: python

  delete-markdown:
    if: github.event.action == 'deleted'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Delete Markdown
        run: |
          import os
          import json
          import glob
          import requests
          
          # ì´ë²¤íŠ¸ ë°ì´í„° ì½ê¸°
          event_path = os.getenv('GITHUB_EVENT_PATH')
          with open(event_path, 'r', encoding='utf-8') as f:
              event = json.load(f)
          
          issue_number = event['issue']['number']
          
          # í•´ë‹¹ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ê°€ì§„ íŒŒì¼ ì°¾ê¸°
          files = glob.glob(f"docs/issues/{issue_number}-*.md")
          
          if files:
              # Git ì„¤ì •
              os.system('git config --global user.name "github-actions[bot]"')
              os.system('git config --global user.email "github-actions[bot]@users.noreply.github.com"')
              
              # íŒŒì¼ ì‚­ì œ ë° ì»¤ë°‹
              for file in files:
                  os.remove(file)
                  os.system(f'git add "{file}"')
              
              os.system(f'git commit -m "sync: Remove markdown for deleted issue #{issue_number}"')
              os.system('git push')
        shell: python
